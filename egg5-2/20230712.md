# 20230712 デモ手順

## 02. 作業環境の準備

以下のコマンドを Cloud Shell で実行し、プロジェクトIDを設定してください。
```text
gcloud config set project <あなたのプロジェクト ID>
```

サンプルアプリケーションのソースコードをクローンします。
```bash
git clone https://github.com/kazshinohara/spanner-sqlalchemy-demo
```

Python のパッケージ及び仮想環境を管理するため [Poetry](https://python-poetry.org/) をインストールします。
```bash
curl -sSL https://install.python-poetry.org | python3 -
```

Poetry のPATH を通しておきます。  
`~/.profile` に同じものが追記されているので次回以降 Cloud Shell にログインする際は、このステップはスキップして OK です。
```bash
export PATH="$HOME/.poetry/bin:$PATH"
```

先程クローンしたサンプルアプリケーションのレポジトリに移動します。
```bash
cd spanner-sqlalchemy-demo
```

テストアプリケーションを実行するための仮想環境を構成します。
以下のコマンドにより `pyproject.toml` に記載された依存パッケージをインストールした仮想環境が立ち上がります。
```bash
poetry install
```

Cloud Shell のターミナルに、以下のコマンド入力し、後ほど利用する Spanner CLI の Linux 用のバイナリをインストールします。
```bash
go install github.com/cloudspannerecosystem/spanner-cli@latest
```

## 03-1. Cloud Spanenr 構築
### **API の有効化**
Cloud Spanner の API を有効化します。  

```bash
gcloud services enable spanner.googleapis.com
```
### **Cloud Spanner インスタンスの作成**
以下の手順は、[Google Cloud のコンソール](https://console.cloud.google.com/) を開いて行ってください。

1. ナビゲーションメニューから`Spanner`を選択  
   Cloud Spanner をはじめて使う場合は API を有効化するステップが必要になるので、そのまま有効化してください。

![](https://storage.googleapis.com/handson-images/egg5-2_navigation_menu_spanner.png)

2. `インスタンスを作成`を選択

![](https://storage.googleapis.com/handson-images/egg5-2_create_spanner_instance.png)


以下の内容で設定して`作成`を選択します。
1. インスタンス名： `demo`
2. インスタンス ID： `demo`
3. `リージョン`を選択
4. `asia-northeast1 (Tokyo)`を選択
5.  コンピューティング容量の割り当て：単位を`ノード`にしつつ、数量を `1` に指定
6. `作成`を選択

![](https://storage.googleapis.com/handson-images/egg5-2_create_spanner_instance_detail.png)

### **データベースの作成**

まだ Cloud Spanner のインスタンスしか作成していないので、データベース及びテーブルを作成していきます。  
1つの Cloud Spanner インスタンスには、複数のデータベースを作成することができます。

1. `demo` を選択すると画面が遷移します  
![](https://storage.googleapis.com/handson-images/egg5-2_select_spanner_instance.png)


2. `データベースを作成`を選択します  
![](https://storage.googleapis.com/handson-images/egg5-2_select_create_database.png)


3. データーベースの設定詳細を入力します  
![](https://storage.googleapis.com/handson-images/egg5-2_create_database.png)

データベース名には`ranking`と入力します。  
スキーマの定義には以下の DDL を貼り付けて、`作成` を押します。
```sql
CREATE TABLE users (
                       user_id STRING(36) NOT NULL,
                       name STRING(MAX) NOT NULL,
                       created_at TIMESTAMP NOT NULL,
                       updated_at TIMESTAMP NOT NULL,
) PRIMARY KEY(user_id);

CREATE TABLE scores (
                        user_id STRING(36) NOT NULL,
                        score_id STRING(36) NOT NULL,
                        score INT64 NOT NULL,
                        created_at TIMESTAMP NOT NULL,
                        updated_at TIMESTAMP NOT NULL,
) PRIMARY KEY(user_id, score_id),
  INTERLEAVE IN PARENT users ON DELETE CASCADE;

CREATE INDEX ix_scores_score ON scores(score);
```


## 03-2 Cloud Shell 上でテストアプリ動作確認

### **環境変数の設定**
テストアプリケーションの実行に必要な環境変数を設定します。

ハンズオンで使っている Google Cloud のプロジェクト ID を設定します。
```bash
export PROJECT_ID=$(gcloud config get-value project)
```

先程作成した Cloud Spanner のインスタンス ID を設定します。
```bash
export INSTANCE_ID="demo"
```

同じく作成済みの Cloud Spanner のデータベース ID を設定します。
```bash
export DATABASE_ID="ranking"
```

この後のステップで作成するテストアプリケーションが Cloud Spanner へ接続するために必要なサービスアカウントとそのキーファイルの名前を設定します。
```bash
export SA_NAME="spanner-demo"
export SA_KEY_NAME="spanner-demo-key"
```

### **サービスアカウントの作成**
テストアプリケーションから Cloud Spanner へ接続するために必要となるサービスアカウントの作成を行います。
```bash
gcloud iam service-accounts create ${SA_NAME}
```

Cloud Spanner にデータを読み書きするためのロールを紐付けます。
```bash
gcloud projects add-iam-policy-binding ${PROJECT_ID} --member "serviceAccount:${SA_NAME}@${PROJECT_ID}.iam.gserviceaccount.com" --role "roles/spanner.databaseUser"
```

続いてサービスアカウントのキーファイルを Cloud Shell にダウンロードします。
```bash
gcloud iam service-accounts keys create ${SA_KEY_NAME} \
--iam-account=${SA_NAME}@${PROJECT_ID}.iam.gserviceaccount.com
```

ダウンロードしたキーファイルのロケーションを環境変数として設定し、テストアプリケーションから使えるようにします。
```bash
export GOOGLE_APPLICATION_CREDENTIALS="/home/$(whoami)/spanner-sqlalchemy-demo/spanner-demo-key"
```

### **テストアプリケーションの実行**
テストアプリケーションを実行します。
```bash
poetry run uvicorn app.main:app --port 8080 --reload
```

以下のような出力があればテストアプリケーションは正常に起動出来ています。
```terminal
INFO:     Uvicorn running on http://127.0.0.1:8080 (Press CTRL+C to quit)
INFO:     Started reloader process [583] using statreload
INFO:     Started server process [586]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
```

### **テストアプリケーションの Swagger UI への接続**
テストアプリケーションで使用している FastAPI という Web フレームワークは [OpenAPI](https://github.com/OAI/OpenAPI-Specification)
をベースにしており、[Swagger UI](https://github.com/swagger-api/swagger-ui) がデフォルトで提供されています。
この Swagger UI を使ってテストアプリケーションに実装済みの REST API を呼び出し Cloud Spanner へのデータ読み書きを行うことが可能です。

Cloud Shell の Web preview 機能を使ってテストアプリケーションの Swagger UI へ接続します。
![](https://storage.googleapis.com/handson-images/egg5-2_select_web_preview.png)

テストアプリケーションは Cloud Shell 上で 8080 番でリッスンしている状態なので、
そのままポート 8080 でプレビューを選択します。  
![](https://storage.googleapis.com/handson-images/egg5-2_select_preview_8080.png)

以下のような画面が別タブで表示されれば成功です。
![](https://storage.googleapis.com/handson-images/egg5-2_fastapi_doc_top.png)

この Swagger UI を使わなくても例えば curl コマンドなどを使って、テストアプリケーションの REST API を呼び出すことも可能です。
試す場合は 以下のように Cloud Shell の別タブを開いてください。
![](https://storage.googleapis.com/handson-images/egg5-2_open_another_cloud_shell_tab.png)

例えばヘルスチェック用の API を呼び出す場合は、以下の通りです。
```bash
curl -s http://127.0.0.1:8080/health/ | jq
```
### **テストアプリケーションを通じたデータの読み書き**
ユーザーのリストを取得してみます。`GET /users/` を選択してください。  
![](https://storage.googleapis.com/handson-images/egg5-2_select_get_users.png)

`GET /users/` の API 定義が確認出来ます。`Try it out` を選択してください。  
![](https://storage.googleapis.com/handson-images/egg5-2_try_it_out.png)

そのまま `Execute` を選択してください。実際に API が呼び出されます。　　 
![](https://storage.googleapis.com/handson-images/egg5-2_execute.png)

レスポンスが下に表示されます。この時点ではまだ何も Cloud Spanner へデータ書き込みしていない状態なので、
空のリストが返ってきます。その他、HTTP のレスポンスコードやレスポンスヘッダーなども確認出来ます。
![](https://storage.googleapis.com/handson-images/egg5-2_get_users_response.png)

ではこの要領で以降のステップを進めていきます。  
まずはユーザーを作成してみましょう。 `POST /users/` を使います。  
![](https://storage.googleapis.com/handson-images/egg5-2_post_user.png)

`name` というパラメーターがあるので任意の文字列を入力してください。(例: ご自身のお名前など)
![](https://storage.googleapis.com/handson-images/egg5-2_post_user_execute.png)

レスポンスを確認します。`user_id` が生成されています。  
Cloud Spanner 上では users テーブルの主キーとして使われており、UUIDv4 を使っています。  
![](https://storage.googleapis.com/handson-images/egg5-2_post_user_response.png)

最後にユーザー削除して一旦終わり。

## ## 03-3 Spanner CLI
### **ダミーデータの入力**
Spanner CLI の前に Cloud Spanner にダミーデータを書き込んでおきましょう。  
**(注意) この作業は前のステップで uuid などを作った Cloud Shell のタブを使ってください。**

はじめに、以下のコマンドを Cloud Shell で実行し、プロジェクトIDを設定してください。
```text
gcloud config set project <あなたのプロジェクト ID>
```

次に必要な環境変数を設定します。
```bash
export PROJECT_ID=$(gcloud config get-value project)
```
```bash
export INSTANCE_ID="demo"
```
```bash
export DATABASE_ID="ranking"
```
```bash
export GOOGLE_APPLICATION_CREDENTIALS="/home/$(whoami)/spanner-sqlalchemy-demo/spanner-demo-key"
```

次にテストアプリケーションのレポジトリのルートディレクトリに移動します。
```bash
cd /home/$(whoami)/spanner-sqlalchemy-demo
```

ダミーデータを書き込むスクリプトを実行します。 
このスクリプトは 100 ユーザー、10000 スコアを Cloud Spanner へ直接書き込みます。Cloud Spanner との接続には前述のクライントライブラリを使っています。
興味のある方は中身も確認してみてください。

スクリプトを実行します。
```bash
poetry run ./tests/insert_data.py
```
エラーとなる場合は以前のステップで設定した環境変数(INSTANCE_ID, DATABASE_ID, GOOGLE_APPLICATION_CREDENTIALS)が
設定されていることを確認してください。

数分でダミーデータの書き込みが終わります。無事完了すると以下のようなメッセージが表示されているはずです。
```terminal
Inserted user data.
Read users
Inserted score data.
```

### **SQL によるインタラクティブな操作**

では Spanner CLI を触っていきましょう。
以下の通りコマンドを実行すると、Cloud Spanner に接続できます。

```bash
spanner-cli -p $PROJECT_ID -i $INSTANCE_ID -d $DATABASE_ID
```

![](https://storage.googleapis.com/handson-images/egg5-2_spanner_cli_entry.png)

先程のスクリプトでスコアが本当に 10000 件書き込みされているか確認してみましょう。
```sql
SELECT COUNT(*) FROM scores;
```

さらに、以下のような SELECT 文を実行し、スコアを昇順に表示してみましょう。
9000 以上のスコアのトップ 10 がユーザー名とともに表示されます。
```sql
SELECT s.score_id, s.score, s.user_id, u.name
FROM scores@{FORCE_INDEX=ix_scores_score} s
INNER JOIN users u ON s.user_id = u.user_id
WHERE score >= 9000 
ORDER BY score DESC LIMIT 10; 
```

先程の SELECT 文の頭に `EXPLAIN` を追加して実行してみましょう。クエリプラン（実行計画）を表示することができます。  
クエリプランは Cloud Console 上でも表示できます。
テーブル作成時に DDL で指定した通り、`score` の値でインデックスを作成していますので、
そちらを使うよう `FORCE_INDEX` ディレクティブでインデックス名を指定します。
```sql
EXPLAIN
SELECT s.score_id, s.score, s.user_id, u.name
FROM scores@{FORCE_INDEX=ix_scores_score} s
INNER JOIN users u ON s.user_id = u.user_id
WHERE score >= 9000
ORDER BY score DESC LIMIT 10; 
```

Cloud Spanner では、クエリを効率化する可能性のあるインデックスが自動的に使用されますが、重要なクエリについては、
より安定したパフォーマンスのため、今回のように `FORCE_INDEX` ディレクティブを使うことを推奨しています。
![](https://storage.googleapis.com/handson-images/egg5-2_spanner_query_plan2.png)

最後に spanner-cli を終了します。
```bash
exit;
```

## 04. コンテナイメージビルド

### 環境変数の設定

後続の手順で利用しますので、環境変数の設定を行います。
Atrifact Registy のリポジトリ名を設定します。
適当な名前を事前に入力していますが、任意のリポジトリ名でも問題ありません。

```bash
export REPOSITORY_NAME="demo"
```

Cloud Run へアプリケーションをデプロイする際、リージョンの指定が必要です。
今回は Cloud Spanner のインスタンスと同じリージョンを指定しておきましょう。
```bash
export LOCATION="asia-northeast1"
```

### APIの有効化
利用する API を有効化します。
```bash
gcloud services enable \
artifactregistry.googleapis.com 
```

### **リポジトリを作成（Artifact Registry）**

リポジトリを作成します。
```bash
gcloud artifacts repositories create ${REPOSITORY_NAME} --repository-format=docker --location=${LOCATION} --description="Docker repository for Cloud Run demo"
```

念の為、レポジトリが作成されたことを確認します。
```bash
gcloud artifacts repositories list
```
※[コンソール](https://console.cloud.google.com/artifacts)から、リポジトリの確認が可能です。

リポジトリにコンテナイメージを Push するための権限を付与
```bash
gcloud auth configure-docker asia-northeast1-docker.pkg.dev
```

### **コンテナイメージを作成**

clone したディレクトリに移動します。
```bash
cd spanner-sqlalchemy-demo 
```

docker build コマンドで、コンテナイメージを作成します。
```bash
docker build -t asia-northeast1-docker.pkg.dev/${PROJECT_ID}/${REPOSITORY_NAME}/spanner-sqlalchemy-demo:1.0.0 .
```

### **コンテナイメージを、Artifact Registry に Push**
```bash
docker push asia-northeast1-docker.pkg.dev/${PROJECT_ID}/${REPOSITORY_NAME}/spanner-sqlalchemy-demo:1.0.0
```

## 05. Cloud Run 構築
### **Cloud Runへデプロイ**

利用する API を有効化します。
```bash
gcloud services enable \
run.googleapis.com
```

Cloud Run へのデプロイ(Cloud Console がベター)
```bash
gcloud run deploy spanner-sqlalchemy-demo \
--image asia-northeast1-docker.pkg.dev/${PROJECT_ID}/${REPOSITORY_NAME}/spanner-sqlalchemy-demo:1.0.0 \
--allow-unauthenticated \
--set-env-vars=PROJECT_ID=${PROJECT_ID},INSTANCE_ID=${INSTANCE_ID},DATABASE_ID=${DATABASE_ID} \
--service-account=${SA_NAME}@${PROJECT_ID}.iam.gserviceaccount.com \
--region=${LOCATION} 
```

### **サービスの動作確認(Cloud Run 構築-2)**

Web でやる

### **トラフィック分割(Cloud Run 構築-3)** 

まず新リビジョンをトラフィックを流さない状態でデプロイし、徐々にトラフィックを流すように設定します。

```bash
 gcloud run deploy spanner-sqlalchemy-demo --image asia-northeast1-docker.pkg.dev/${PROJECT_ID}/${REPOSITORY_NAME}/spanner-sqlalchemy-demo:1.0.0 \
 --allow-unauthenticated \
 --no-traffic \
 --set-env-vars=PROJECT_ID=${PROJECT_ID},INSTANCE_ID=${INSTANCE_ID},DATABASE_ID=${DATABASE_ID} \
 --service-account=${SA_NAME}@${PROJECT_ID}.iam.gserviceaccount.com \
 --region=${LOCATION} 
```

この時点では、１つ前のリビジョンにトラフィックがルーティングされており、新しいアプリケーションは公開されていません。以下のコマンドで確認します。

```bash
APP_URL=$(gcloud run services describe spanner-sqlalchemy-demo --region=${LOCATION} --format json | jq -r '.status.address.url')
curl ${APP_URL}/cloud-run-info/ && echo
```

(Cloud Console で良い)
最新のリビジョンと、１つ前のリビジョンを取得して起きましょう。
```bash
export NEW_REV=$(gcloud run revisions list --format json | jq -r '.[].metadata.name' | grep 'spanner-sqlalchemy-demo' | sort -r | sed -n 1p)
export OLD_REV=$(gcloud run revisions list --format json | jq -r '.[].metadata.name' | grep 'spanner-sqlalchemy-demo' | sort -r | sed -n 2p)
echo NEW:${NEW_REV}
echo OLD:${OLD_REV}
```

(Cloud Console で良い)
新リビジョンが10%、旧リビジョンが90%の割合で、トラフィックを分割します。
```bash
gcloud run services update-traffic spanner-sqlalchemy-demo --to-revisions=${NEW_REV}=10,${OLD_REV}=90
```

また複数回、/cloud-run-info/ にアクセスして、トラフィックが分割されているか確認してみましょう。
```bash
while true; do curl ${APP_URL}/cloud-run-info/ && echo;sleep 0.5s; done
```
※Ctrl + c で停止してください。

## 06. モニタリングとロギング
### 負荷掛けとスケールアウト

Hey を使って demo サービスに負荷を掛けます。Hey は Cloud Shell にデフォルトでインストールされているため、新たにインストールする必要はありません。 
demo サービスへの GET リクエストを 合計 60000 回、 320 並列 で実行します。
```bash
hey -n 60000 -c 320 ${APP_URL}/cloud-run-info/
```

[コンソール](https://console.cloud.google.com/run/detail/{{region}}/spanner-sqlalchemy-demo/) もしくは [Cloud Monitoring](https://console.cloud.google.com/monitoring/metrics-explorer?pageState=%7B%22xyChart%22:%7B%22dataSets%22:%5B%7B%22timeSeriesFilter%22:%7B%22filter%22:%22metric.type%3D%5C%22run.googleapis.com%2Fcontainer%2Finstance_count%5C%22%20resource.type%3D%5C%22cloud_run_revision%5C%22%20resource.label.%5C%22service_name%5C%22%3D%5C%22spanner-sqlalchemy-demo%5C%22%20resource.label.%5C%22project_id%5C%22%3D%5C%22{{project-id}}%5C%22%20resource.label.%5C%22location%5C%22%3D%5C%22{{region}}%5C%22%22,%22minAlignmentPeriod%22:%2260s%22,%22aggregations%22:%5B%7B%22perSeriesAligner%22:%22ALIGN_MAX%22,%22crossSeriesReducer%22:%22REDUCE_SUM%22,%22alignmentPeriod%22:%2260s%22,%22groupByFields%22:%5B%22metric.label.%5C%22state%5C%22%22,%22resource.label.%5C%22service_name%5C%22%22,%22resource.label.%5C%22revision_name%5C%22%22%5D%7D,%7B%22perSeriesAligner%22:%22ALIGN_NONE%22,%22crossSeriesReducer%22:%22REDUCE_NONE%22,%22alignmentPeriod%22:%2260s%22,%22groupByFields%22:%5B%5D%7D%5D%7D,%22targetAxis%22:%22Y1%22,%22plotType%22:%22LINE%22%7D%5D,%22options%22:%7B%22mode%22:%22COLOR%22%7D,%22constantLines%22:%5B%5D,%22timeshiftDuration%22:%220s%22,%22y1Axis%22:%7B%22label%22:%22y1Axis%22,%22scale%22:%22LINEAR%22%7D%7D,%22isAutoRefresh%22:true,%22timeSelection%22:%7B%22timeRange%22:%221h%22%7D%7D&project={{project-id}}) で、コンテナインスタンスの数が、どのように変化しているかも確認してみましょう。
